name: Release BiliLiveTool

on:
  push:
    tags:
      - 'v*' # è§¦å‘æ ‡ç­¾ï¼šv1.0, v2.0.1 ç­‰

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            asset_name_suffix: linux-amd64
            pyinstaller_options: ""
            icon_ext: "png"
          - os: macos-latest
            asset_name_suffix: macos-amd64
            pyinstaller_options: "--windowed"
            icon_ext: "icns"
          - os: windows-latest
            asset_name_suffix: windows-amd64
            pyinstaller_options: "--noconsole"
            icon_ext: "ico"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
      shell: bash

    - name: Install Backend Dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller Pillow

    # --- æ­¥éª¤ï¼šè‡ªåŠ¨å¤„ç†å›¾æ ‡ (macOSè½¬icns, Linuxè½¬png) ---
    - name: Prepare Platform Icon
      run: |
        if [ "${{ matrix.os }}" == "macos-latest" ]; then
          echo "Converting ICO to ICNS for macOS..."
          sips -s format png bilibili.ico --out temp_icon.png
          mkdir bilibili.iconset
          sips -z 1024 1024 temp_icon.png --out bilibili.iconset/icon_512x512@2x.png
          iconutil -c icns bilibili.iconset
          rm -rf bilibili.iconset temp_icon.png
        elif [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          echo "Converting ICO to PNG for Linux..."
          python -c "from PIL import Image; Image.open('bilibili.ico').save('bilibili.png')"
        fi
      shell: bash

    # --- æ­¥éª¤ï¼š(æ ¸å¿ƒ) åŠ¨æ€ç”Ÿæˆ Windows ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ ---
    # è¿™æ­¥ä¼šè§£æ git tag (v1.0.0) å¹¶ç”Ÿæˆ version_info.txt
    - name: Generate Windows Version Info
      if: matrix.os == 'windows-latest'
      run: |
        # ä½¿ç”¨ Python è„šæœ¬åŠ¨æ€ç”Ÿæˆ version_info.txt
        cat <<EOF > generate_version.py
        import sys
        
        # è·å– Tag ç‰ˆæœ¬å·ï¼Œå»æ‰ 'v'
        tag = "${{ github.ref_name }}"
        clean_ver = tag.lstrip('v') 
        
        # å°†ç‰ˆæœ¬å·æ‹†åˆ†ä¸º tuple (1, 0, 0, 0)
        parts = clean_ver.split('.')
        while len(parts) < 4: parts.append('0')
        ver_tuple = tuple(map(int, parts[:4]))
        ver_str = clean_ver
        
        # å®šä¹‰ version_info æ¨¡æ¿å†…å®¹
        content = f"""
        # UTF-8
        VSVersionInfo(
          ffi=FixedFileInfo(
            filevers={ver_tuple},
            prodvers={ver_tuple},
            mask=0x3f,
            flags=0x0,
            OS=0x40004,
            fileType=0x1,
            subtype=0x0,
            date=(0, 0)
          ),
          kids=[
            StringFileInfo(
              [
                StringTable(
                  u'040904B0',
                  [StringStruct(u'CompanyName', u'BiliLiveTool Open Source'),
                   StringStruct(u'FileDescription', u'BiliLiveTool Client'),
                   StringStruct(u'FileVersion', u'{ver_str}'),
                   StringStruct(u'InternalName', u'BiliLiveTool'),
                   StringStruct(u'LegalCopyright', u'Copyright (c) 2026 Open Source'),
                   StringStruct(u'OriginalFilename', u'BiliLiveTool.exe'),
                   StringStruct(u'ProductName', u'BiliLiveTool'),
                   StringStruct(u'ProductVersion', u'{ver_str}')])
              ]
            ),
            VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
          ]
        )
        """
        
        with open("version_info.txt", "w", encoding="utf-8") as f:
            f.write(content)
            print(f"Generated version_info.txt for version {ver_str}")
        EOF
        
        # æ‰§è¡Œç”Ÿæˆè„šæœ¬
        python generate_version.py
      shell: bash

    - name: Package with PyInstaller
      run: |
        ICON_NAME="bilibili.${{ matrix.icon_ext }}"
        
        # å¦‚æœæ˜¯ Windowsï¼Œæ·»åŠ ç‰ˆæœ¬æ–‡ä»¶å‚æ•°
        EXTRA_ARGS=""
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
           EXTRA_ARGS="--version-file=version_info.txt"
            pyinstaller main.py \
          --name BiliLiveTool \
          --onefile \
          --add-data "frontend/dist:frontend/dist" \
          --icon "$ICON_NAME" \
          $EXTRA_ARGS \
          ${{ matrix.pyinstaller_options }}
        elif [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
           pyinstaller main.py --name BiliLiveTool --onefile \
            --add-data "frontend/dist:frontend/dist" \
            --hidden-import _cffi_backend \
            --hidden-import cffi \
            --hidden-import qtpy \
            --hidden-import PyQt5 \
            --hidden-import webview.platforms.qt\
            --hidden-import brotli\
            --collect-all cffi \
            --collect-all brotli

        else
            pyinstaller main.py \
              --name BiliLiveTool \
              --onefile \
              --add-data "frontend/dist:frontend/dist" \
              --icon "$ICON_NAME" \
              $EXTRA_ARGS \
              ${{ matrix.pyinstaller_options }}
        fi


      shell: bash

    - name: Prepare Artifacts
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          EXE_NAME="BiliLiveTool.exe"
          ASSET_NAME="BiliLiveTool-${{ matrix.asset_name_suffix }}.zip"
          mv dist/$EXE_NAME .
          7z a $ASSET_NAME $EXE_NAME
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          APP_NAME="BiliLiveTool.app"
          ASSET_NAME="BiliLiveTool-${{ matrix.asset_name_suffix }}.zip"
          7z a -r $ASSET_NAME dist/$APP_NAME
        else # Linux
          EXE_NAME="BiliLiveTool"
          ASSET_NAME="BiliLiveTool-${{ matrix.asset_name_suffix }}.tar.gz"
          mv dist/$EXE_NAME .
          tar -czvf $ASSET_NAME $EXE_NAME
        fi
        echo "ASSET_NAME=${ASSET_NAME}" >> $GITHUB_ENV
      shell: bash

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BiliLiveTool-${{ matrix.asset_name_suffix }}
        path: ${{ env.ASSET_NAME }}

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*/*
        body: |
          ## ğŸš€ BiliLiveTool ${{ github.ref_name }} å‘å¸ƒ
          
          ### ğŸ“¦ ä¸‹è½½åœ°å€
          è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©ï¼š
          - **Windows**: ä¸‹è½½ `.zip` è§£å‹ä½¿ç”¨
          - **macOS**: ä¸‹è½½ `.zip` è§£å‹è¿è¡Œ
          - **Linux**: ä¸‹è½½ `.tar.gz`

          ### ğŸ›¡ï¸ Windows ç”¨æˆ·å®‰å…¨æç¤º
          å¦‚æœæ‚¨åœ¨ Windows ä¸Šè¿è¡Œé‡åˆ° **"Windows å·²ä¿æŠ¤ä½ çš„ç”µè„‘"** (SmartScreen) è“æ¡†æç¤ºï¼š
          1. ç‚¹å‡» **"æ›´å¤šä¿¡æ¯" (More Info)**
          2. ç‚¹å‡» **"ä»è¦è¿è¡Œ" (Run Anyway)**
          
          > è¿™æ˜¯å› ä¸ºå¼€æºè½¯ä»¶æœªè´­ä¹°æ˜‚è´µçš„æ•°å­—è¯ä¹¦ï¼Œå±äºæ­£å¸¸ç°è±¡ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚

        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}